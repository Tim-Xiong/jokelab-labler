<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joke Punchline Labeler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card mt-5">
                    <div class="card-header">
                        <h1 class="text-center">Joke Punchline Labeler</h1>
                    </div>
                    <div class="card-body">
                        <div class="instructions mb-4">
                            <h5>Instructions:</h5>
                            <p>1. Read the joke below</p>
                            <p>2. Highlight one or more punchlines with your mouse</p>
                            <p>3. Click "Add Selection" to mark each punchline</p>
                            <p>4. If the joke isn't funny, click "No Punchline"</p>
                            <p>5. Click "Submit" when you're done</p>
                        </div>
                        
                        <div id="joke-container" class="mb-4">
                            <p id="joke-text" class="joke-text"></p>
                            <input type="hidden" id="joke-id">
                        </div>

                        <div id="selections-container" class="mb-3">
                            <h6>Selected Punchlines:</h6>
                            <div id="selections-list" class="selections-list"></div>
                        </div>

                        <div class="buttons text-center">
                            <button id="add-selection-btn" class="btn btn-success me-2">Add Selection</button>
                            <button id="clear-btn" class="btn btn-secondary me-2">Clear All</button>
                            <button id="no-punchline-btn" class="btn btn-warning me-2">No Punchline</button>
                            <button id="submit-btn" class="btn btn-primary" disabled>Submit</button>
                        </div>

                        <div id="message" class="alert mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
            <!-- Sidebar for Disclaimer -->
            <div class="col-md-4 mt-5">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5>Disclaimer</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            All jokes are randomly sampled from the Kaggle dataset short jokes. It has been attempted to keep the jokes as clean as possible. Since the data has been collected by scraping websites, it is possible that there may be a few jokes that are inappropriate or offensive to some people.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script and Style Section -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentSelections = [];
            let noPunchline = false;
            
            function loadNewJoke() {
                fetch('/get_joke')
                    .then(response => response.json())
                    .then(data => {
                        if (data.id) {
                            document.getElementById('joke-text').textContent = data.text;
                            document.getElementById('joke-id').value = data.id;
                            resetUI();
                        } else {
                            showMessage('No more jokes to label!', 'warning');
                        }
                    })
                    .catch(error => showMessage('Error loading joke', 'danger'));
            }

            function resetUI() {
                currentSelections = [];
                noPunchline = false;
                updateSelectionsDisplay();
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('no-punchline-btn').disabled = false;
                document.getElementById('add-selection-btn').disabled = false;
            }

            function updateSelectionsDisplay() {
                const container = document.getElementById('selections-list');
                container.innerHTML = '';
                
                currentSelections.forEach((selection, index) => {
                    const div = document.createElement('div');
                    div.className = 'selection-item';
                    div.textContent = `"${selection.text}"`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger ms-2';
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.onclick = () => {
                        currentSelections.splice(index, 1);
                        updateSelectionsDisplay();
                        updateSubmitButton();
                    };
                    
                    div.appendChild(deleteBtn);
                    container.appendChild(div);
                });
            }

            function updateSubmitButton() {
                document.getElementById('submit-btn').disabled = 
                    !noPunchline && currentSelections.length === 0;
            }

            function showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = `alert alert-${type} mt-3`;
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            document.getElementById('add-selection-btn').addEventListener('click', function() {
                const selection = window.getSelection();
                const text = selection.toString().trim();
                
                if (text) {
                    const range = selection.getRangeAt(0);
                    currentSelections.push({
                        text: text,
                        start: range.startOffset,
                        end: range.endOffset
                    });
                    
                    updateSelectionsDisplay();
                    updateSubmitButton();
                    selection.removeAllRanges();
                }
            });

            document.getElementById('no-punchline-btn').addEventListener('click', function() {
                noPunchline = true;
                currentSelections = [];
                updateSelectionsDisplay();
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('add-selection-btn').disabled = true;
                this.disabled = true;
            });

            document.getElementById('submit-btn').addEventListener('click', function() {
                const jokeId = document.getElementById('joke-id').value;
                
                fetch('/submit_label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        joke_id: jokeId,
                        segments: currentSelections.map(s => ({
                            start: s.start,
                            end: s.end
                        })),
                        no_punchline: noPunchline
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showMessage('Label submitted successfully!', 'success');
                    loadNewJoke();
                })
                .catch(error => showMessage('Error submitting label', 'danger'));
            });

            document.getElementById('clear-btn').addEventListener('click', function() {
                window.getSelection().removeAllRanges();
                resetUI();
            });

            // Load first joke on page load
            loadNewJoke();
        });
    </script>

    <style>
        .selection-item {
            background-color: #f8f9fa;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selections-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
    </style>
</body>
</html>
